<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JSInspector devtools</title>
    <script src="lib/zepto.min.js"></script>
    <script src="lib/vue.min.js"></script>
    <script src="jsondiffpatch.js"></script>
    <link rel="stylesheet" href="inspector.css">
</head>
<body>
    <!-- inpsctor inspected device view frame -->
    <iframe src="about:blank" frameborder="0" id="inspectorFrame"></iframe>

    <!-- inspector elements panel -->    
    <div id="wrapper" style="font-size: 10px;display:none;"></div>
    <script type="text/teamplate" id="tpl-style-list">
        <ul>
            <li v-repeat="sheets" class="stylesheet">
                <div class="content">
                    <div class="head">
                        <div class="selector">{{selectorText}} {</div>
                        <a class="href" href="{{href}}">{{href | source}}</a>
                    </div>
                    <div class="rules">
                        <div v-repeat="styleRules" class="rule">
                            <div type="text" class="style-selector" contenteditable=true draggable=false>{{selector}}</div>:
                            <div type="text" class="style-value" contenteditable=true draggable=false>{{value}}</div>;
                        </div>
                    </div>
                    <div class="foot">}</div>
                </div>
            </li>
        </ul>
    </script>
    <script src="inspector.view.js"></script>
    <script src="inspector.test.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io.connect('<%= host %>'),
            inspectorId = '<%= inspectorId %>',
            inspectorFrame = document.querySelector('#inspectorFrame'),
            slice = Array.prototype.slice,
            documentBase = '',
            isDocumentInited = false,
            initRetry = 0,
            jdpInstance = jsondiffpatch.create({
                textDiff: {
                    maxLength: 60
                }
            });

        /**
         *  update inspected device view
         **/
        function updateInspectorFrame (data) {

            var ispDoc = inspectorFrame.contentDocument,
                ispWin = inspectorFrame.contentWindow;

            if (data.html) {
                documentBase = data.html;
                writeDocument(ispDoc, ispWin, documentBase);
            } else if (data.delta) {
                documentBase = jdpInstance.patch(documentBase, data.delta);
                writeDocument(ispDoc, ispWin, documentBase);
            }

            if (data.html) {
                if (data.meta.scrollTop !== undefined) {
                    ispWin.scrollTo(0, data.meta.scrollTop);
                }
            }
        }
        /**
         *  Write iframe document
         **/
        function writeDocument (ispDoc, ispWin, html) {
            ispDoc.open();
            // remove inspector CORS frame src and save dom for Xpath
            html = html.replace(/<iframe\s*src="[^"]*"\s*id="__jsinspector_cors_iframe"/, 
                '<iframe src="" id="__jsinspector_cors_iframe"');
            ispDoc.write(html);
            ispDoc.close();
        }

        /**
         *  comment
         **/
        function documentInitialize (success, error) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200 && xhr.responseText) {
                    success && success(xhr.responseText);
                } else if (xhr.readyState == 4 && (xhr.status != 200 || !xhr.responseText)) {
                    error && error();
                }
            }
            xhr.open('GET', '/inspect_html_init?<%= inspectorId %>')
            xhr.send(null);
        }

        /**
         *  Initialize function for get full document text
         **/
        function initialize () {
            if (initRetry > 5) return;
            initRetry ++;
            documentInitialize(function (data) {
                isDocumentInited = true;
                documentBase = data.html;
                updateInspectorFrame(JSON.parse(data));
            }, function () {
                setTimeout(function() {
                    initialize();
                }, 500);
            })
        }

        initialize();
        // receive document sync data
        socket.on('inspect:html:update:<%= inspectorId %>', function (data) {
            data = JSON.parse(data);
            if (isDocumentInited) {
                // document has not inited
                if (data.html) documentBase = data.html;
                updateInspectorFrame(data);
            } else if (!isDocumentInited && data.html){
                documentBase = data.html;
                updateInspectorFrame(data);
            }
        });
    </script>
</body>
</html>