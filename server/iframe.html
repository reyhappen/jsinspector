<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>iframe using for cross-domain request</title>
</head>
<body>
    <script>
        window.addEventListener('message', function (event) {

            if (Object.prototype.toString.call(event.data) !== '[object Object]') return;
            var options = event.data;

            if (options.static) {
                request({
                    url: '/src',
                    data: {
                        url: encodeURIComponent(options.url)
                    },
                    success: function (data, xhr) {
                        event.source.postMessage({
                            id: options.id,
                            data: data,
                            status: xhr.status
                        }, '*');
                    }
                });
            } else {
                request({
                    method: options.method,
                    url: options.url,
                    data: options.data,
                    type: options.type,
                    success: function (data, xhr) {
                        event.source.postMessage({
                            id: options.id,
                            data: data,
                            status: xhr.status
                        }, '*');
                    },
                    error: function (err, xhr) {
                        event.source.postMessage({
                            id: options.id,
                            error: err,
                            status: xhr.status
                        }, '*');
                    }
                });                
            }
        });

        function request (options) {
            var xhr = new XMLHttpRequest(),
                method = options.method ? options.method.toUpperCase() : "GET";

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var data = xhr.responseText;
                    options.success && options.success(data, xhr);
                } else {
                    options.error && options.error('', xhr);
                } 
            }

            var params = [];
            if (options.data && Object.prototype.toString.call(options.data) !== '[object String]') {
                // to query string
                var keys = Object.keys(options.data);
                keys.forEach(function (item, index) {
                    var value = options.data[item];
                    if (Object.prototype.toString.call(value) == '[object String]') {
                        params.push(item + '=' + value);
                    } else {
                        params.push(item + '=' + JSON.stringify(value));
                    }
                });
                params = params.join('&');
            } else {
                params = options.data;
            }

            if (method == 'POST' || method == 'PUT' || !options.data) {
                xhr.open(method, options.url, false);
                xhr.setRequestHeader("Content-Type", options.type || "application/x-www-form-urlencoded");
                xhr.send(params);
                
            } else {
                xhr.open(method, options.url + '?' + params, false);
                xhr.send(null);
            }
        }
    </script>
</body>
</html>